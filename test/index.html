<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-size: 12px;
      line-height: 18px;
      font-family: "Lucida Grande";
      color: #333;
    }

    ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    li {
      margin: 10px 0;
    }

    .col1 {
      width: 100%;
    }

    .col2 {
      width: 50%;
      float: left;
      padding: 10px;
    }

    .col3 {
      width: 33%;
      float: left;
      padding: 10px;
    }

  </style>
</head>
<body>
<div>

  <div class="col3">
    <h2>Sources</h2>
    <form action="" method="post" id="form-add-source">
      <input class="col1" type="text" placeholder="add a source" />
    </form>
    <ul id="list-source"></ul>
  </div>

  <div class="col2">
    <h2>Notes</h2>
    <form action="" method="post" id="form-add-note">
      <textarea class="col1" placeholder="add a note" name="" id="" cols="30" rows="3"></textarea>
      <input class="col1" type="submit"/>
    </form>
    <ul id="list-note"></ul>
  </div>

  <script src="../build/no-framework.js"></script>
  <script>
    var nf = require('nf');

    var repo = nf.createRepository({
      localStorage: nf.stores.localStorage()
    });

    var Note = nf.Model('Note', 'localStorage', repo);
    var Source = nf.Model('Source', 'localStorage', repo);

    var activeSource;
    var activeNotesFeedCollection;

    var notesForm = document.querySelector('#form-add-note');
    var notesList = document.querySelector('#list-note');

    notesForm.addEventListener('submit', function (event) {
      event.preventDefault();
      event.stopPropagation();
      var n = Note({text: event.currentTarget[0].value});
      activeNotesFeedCollection.add(n);
      event.currentTarget[0].value = '';
    }, false);

    var sourcesForm = document.querySelector('#form-add-source');
    var sourcesList = document.querySelector('#list-source');

    sourcesList.addEventListener('click', function (event) {
      event.preventDefault();
      event.stopPropagation();
      if (event.target.tagName.toLowerCase() === 'a') {
        var id = parseInt(event.target.dataset.id, 10);
        var source = repo.find('Source', id);
        onActiveSourceChange(source);
      }
    }, true);

    sourcesForm.addEventListener('keydown', function (event) {
      if (event.which != 13) {
        return;
      }
      event.preventDefault();
      event.stopPropagation();
      var s = Source({text: event.currentTarget[0].value});
      sourceListCollection.add(s);
      event.currentTarget[0].value = '';
    }, false);

    var sourceListCollection = nf.Collection({
      init: function (resolve, reject) {
        var models = repo.findAll('Source');
        models.forEach(function (model) {
          this.add(model);
        }, this);
        onActiveSourceChange(models[0]);
        resolve();
      },
      insert: function (models, model) {
        models.unshift(model);
      }
    });

    sourceListCollection.on('add', function (model) {
      repo.save(model);
      onActiveSourceChange(model)
    });

    var sourceListView = nf.CollectionView({
      template: '<li><a data-id="{{id}}" href="source/{{id}}">{{text}}</a></li>',
      collection: sourceListCollection,
      container: sourcesList
    });

    function onActiveSourceChange (source) {
      activeSource = source;
      var noteFeedCollection = nf.Collection({
        init: function (resolve, reject) {
          var models = activeSource.relations.Note;
          if (models) {
            models.forEach(function (model) {
              this.add(model);
            }, this);
          }
          resolve();
        }
      });
      noteFeedCollection.on('add', function (noteModel) {
        repo.save(noteModel);
        activeSource.addRelation(noteModel);
      });
      var noteListView = nf.CollectionView({
        template: '<li>{{text}}</li>',
        collection: noteFeedCollection,
        container: notesList
      });
      activeNotesFeedCollection = noteFeedCollection;
    }

  </script>
</div>
</body>
</html>